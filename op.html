<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>μ¤ν”½ μ¤ν¬λ¦½νΈ λ°λ³µ μ¬μƒκΈ°</title>

    <!-- μ•„μ΄ν° ν™ ν™”λ©΄ μ¶”κ°€μ© -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px 15px 80px;
            background-color: #f4f4f9;
        }
        h2 { color: #333; text-align: center; }
        .container {
            background: white;
            padding: 20px 15px 80px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        textarea {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
            font-size: 16px;
            box-sizing: border-box;
        }
        input[type="number"] {
            width: 70px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 15px;
            transition: 0.2s;
        }
        .btn-add { background-color: #4CAF50; color: white; }
        .btn-play { background-color: #2196F3; color: white; }
        .btn-stop { background-color: #f44336; color: white; }
        .btn-clear { background-color: #9e9e9e; color: white; }
        .list-area { margin-top: 20px; }
        .script-item {
            background: #e3f2fd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 5px solid #2196F3;
            font-size: 14px;
            cursor: pointer;
        }
        .script-item.active-item {
            background: #bbdefb;
            border-left-color: #1565c0;
        }
        .script-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            gap: 6px;
        }
        .script-buttons {
            display: flex;
            gap: 4px;
        }
        .script-btn {
            flex: 0 0 auto;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }
        .script-btn-edit { background-color: #ffb300; color: #fff; }
        .script-btn-delete { background-color: #d32f2f; color: #fff; }
        .script-btn-toggle { background-color: #90a4ae; color: #fff; }

        .script-detail {
            margin-top: 6px;
            font-size: 13px;
            line-height: 1.5;
        }
        .script-detail.collapsed {
            display: none;
        }

        .status {
            text-align: center;
            margin-top: 10px;
            color: #ff5722;
            font-weight: bold;
            min-height: 20px;
            font-size: 14px;
        }
        .sticky-controls {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 8px 12px 12px;
            background: rgba(255,255,255,0.96);
            border-top: 1px solid #eee;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.06);
        }
        .small-label {
            font-size: 13px;
            font-weight: normal;
            color: #777;
        }
        select, input[type="range"] {
            width: 100%;
            margin-top: 3px;
            margin-bottom: 8px;
            padding: 5px;
            font-size: 13px;
            border-radius: 5px;
            border: 1px solid #ddd;
            box-sizing: border-box;
        }
        .row-2 {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .row-2 > div {
            flex: 1;
            min-width: 130px;
        }
        .hint-text {
            font-size: 12px;
            color: #777;
            margin-top: 4px;
        }
        .set-input {
            width: 100%;
            padding: 6px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 13px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>π—£οΈ μ¤ν”½ μ‰λ„μ‰ ν”λ μ΄μ–΄</h2>

    <!-- μμ„± μ„¤μ • μμ—­ -->
    <div class="input-group">
        <label>μμ„± μ„¤μ •</label>
        <div>
            <span class="small-label">Voice (λ©μ†λ¦¬ μ„ νƒ)</span>
            <select id="voiceSelect">
                <option value="">κΈ°λ³Έ μ‹μ¤ν… μμ„± μ‚¬μ©</option>
            </select>
        </div>
        <div class="row-2">
            <div>
                <span class="small-label">μ†λ„ (0.6 ~ 1.4)</span>
                <input type="range" id="rateRange" min="0.6" max="1.4" step="0.05" value="0.9">
                <span id="rateValue" class="hint-text">ν„μ¬: 0.9</span>
            </div>
            <div>
                <span class="small-label">μ§λ¬Έ/λ‹µλ³€ μ‚¬μ΄ κ°„κ²© (μ΄)</span>
                <input type="number" id="gapSec" min="0" max="5" value="1">
            </div>
        </div>
        <p class="hint-text">β€» iOSμ—μ„λ” μ‚¬νλ¦¬μ—μ„ ν• λ² μ¬μƒ λ²„νΌμ„ λλ¬μ•Ό μμ„± ν•©μ„±μ΄ λ™μ‘ν•©λ‹λ‹¤.</p>
    </div>

    <!-- β… μ„ΈνΈ κ΄€λ¦¬ μμ—­ -->
    <div class="input-group">
        <label>μ„ΈνΈ κ΄€λ¦¬</label>
        <div class="row-2">
            <div>
                <span class="small-label">μ €μ¥λ μ„ΈνΈ μ„ νƒ</span>
                <select id="setSelect">
                    <option value="">μ €μ¥λ μ„ΈνΈ μ—†μ</option>
                </select>
            </div>
            <div>
                <span class="small-label">μƒ μ„ΈνΈ μ΄λ¦„</span>
                <input type="text" id="setNameInput" class="set-input" placeholder="μ: μ§‘ & λ‚ μ”¨ μ„ΈνΈ">
            </div>
        </div>
        <div class="controls" style="margin-top: 8px;">
            <button style="background-color:#673ab7;color:#fff;" onclick="saveCurrentSet()">ν„μ¬ λ©λ΅ μ„ΈνΈ μ €μ¥</button>
            <button style="background-color:#00897b;color:#fff;" onclick="loadSelectedSet()">μ„ΈνΈ λ¶λ¬μ¤κΈ°</button>
            <button style="background-color:#b0bec5;color:#333;" onclick="deleteSelectedSet()">μ„ΈνΈ μ‚­μ </button>
        </div>
        <p class="hint-text">μ„ΈνΈλ΅ μ €μ¥ν•΄ λ‘λ©΄ μ£Όμ λ³„(μ§‘, λ‚ μ”¨, μ·¨λ―Έ λ“±)λ΅ κ³¨λΌμ„ λ“¤μ„ μ μμµλ‹λ‹¤.</p>
    </div>
    
    <!-- Q/A μ…λ ¥ -->
    <div class="input-group">
        <label>Q. μ§λ¬Έ μ…λ ¥ (μμ–΄)</label>
        <textarea id="questionText" placeholder="μ: Tell me about yourself."></textarea>
        <label>μ§λ¬Έ λ°λ³µ νμ: 
            <input type="number" id="qRepeat" value="2" min="1">
        </label>
    </div>

    <div class="input-group">
        <label>A. λ‹µλ³€ μ¤ν¬λ¦½νΈ μ…λ ¥ (μμ–΄)</label>
        <textarea id="answerText" placeholder="μ: I live in Seoul..."></textarea>
        <label>λ‹µλ³€ λ°λ³µ νμ: 
            <input type="number" id="aRepeat" value="5" min="1">
        </label>
    </div>

    <div class="controls">
        <button class="btn-add" id="addBtn" onclick="addOrUpdateScript()">λ©λ΅μ— μ¶”κ°€</button>
        <button class="btn-clear" onclick="clearList()">μ΄κΈ°ν™”</button>
    </div>

    <!-- λ©λ΅ -->
    <div class="list-area" id="playList"></div>

    <div class="status" id="statusMsg"></div>
</div>

<!-- ν•λ‹¨ κ³ μ • μ¬μƒ λ²„νΌ -->
<div class="sticky-controls">
    <div class="controls" style="margin-top: 0;">
        <button class="btn-play" onclick="playAll()">β–¶ μ „μ²΄ μ¬μƒ (λ¬΄ν• λ°λ³µ)</button>
        <button class="btn-stop" onclick="stopAll()">βΉ μ •μ§€</button>
    </div>
</div>

<script>
    let playQueue = [];
    let isPlaying = false;
    let synth = window.speechSynthesis;
    let currentUtterance = null;
    let voices = [];
    let editingIndex = null; // ν„μ¬ μμ • μ¤‘μΈ μΈλ±μ¤
    let currentIndex = null; // ν„μ¬ μ¬μƒ μ¤‘μΈ μΈλ±μ¤
    let expandedDetails = new Set(); // νΌμ³μ§„ μΉ΄λ“ μΈλ±μ¤

    const statusEl = document.getElementById('statusMsg');
    const voiceSelect = document.getElementById('voiceSelect');
    const rateRange = document.getElementById('rateRange');
    const rateValue = document.getElementById('rateValue');
    const addBtn = document.getElementById('addBtn');

    // ---------- localStorage ν‚¤ ----------
    const STORAGE_KEY = 'opic_play_queue_v1';
    const SET_STORAGE_KEY = 'opic_sets_v1';

    let sets = {}; // {μ„ΈνΈλ…: [items...]}

    // ---------- localStorage: λ©λ΅ ----------
    function saveQueue() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(playQueue));
        } catch (e) {
            console.warn('localStorage μ €μ¥ μ‹¤ν¨', e);
        }
    }

    function loadQueue() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return;
            const data = JSON.parse(raw);
            if (Array.isArray(data)) {
                playQueue = data.map(item => ({
                    q: item.q || '',
                    qCnt: item.qCnt || 1,
                    a: item.a || '',
                    aCnt: item.aCnt || 1
                }));
                renderList();
            }
        } catch (e) {
            console.warn('localStorage λ¶λ¬μ¤κΈ° μ‹¤ν¨', e);
        }
    }

    // ---------- localStorage: μ„ΈνΈ ----------
    function loadSetsFromStorage() {
        try {
            const raw = localStorage.getItem(SET_STORAGE_KEY);
            if (!raw) {
                sets = {};
                populateSetSelect();
                return;
            }
            const data = JSON.parse(raw);
            if (data && typeof data === 'object') {
                sets = data;
            } else {
                sets = {};
            }
        } catch (e) {
            console.warn('μ„ΈνΈ λ¶λ¬μ¤κΈ° μ‹¤ν¨', e);
            sets = {};
        }
        populateSetSelect();
    }

    function saveSetsToStorage() {
        try {
            localStorage.setItem(SET_STORAGE_KEY, JSON.stringify(sets));
        } catch (e) {
            console.warn('μ„ΈνΈ μ €μ¥ μ‹¤ν¨', e);
        }
    }

    function populateSetSelect() {
        const sel = document.getElementById('setSelect');
        sel.innerHTML = '';
        const names = Object.keys(sets);
        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.textContent = names.length ? 'μ„ΈνΈλ¥Ό μ„ νƒν•μ„Έμ”' : 'μ €μ¥λ μ„ΈνΈ μ—†μ';
        sel.appendChild(defaultOpt);

        names.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            sel.appendChild(opt);
        });
    }

    function saveCurrentSet() {
        if (playQueue.length === 0) {
            alert('μ €μ¥ν•  λ©λ΅μ΄ μ—†μµλ‹λ‹¤.');
            return;
        }
        const nameInput = document.getElementById('setNameInput');
        let name = nameInput.value.trim();
        if (!name) {
            name = prompt('μ„ΈνΈ μ΄λ¦„μ„ μ…λ ¥ν•μ„Έμ”', '');
            if (!name) return;
        }

        if (sets[name] && !confirm('μ΄λ―Έ κ°™μ€ μ΄λ¦„μ μ„ΈνΈκ°€ μμµλ‹λ‹¤. λ®μ–΄μ“ΈκΉμ”?')) {
            return;
        }

        // κΉμ€ λ³µμ‚¬
        sets[name] = playQueue.map(item => ({
            q: item.q,
            qCnt: item.qCnt,
            a: item.a,
            aCnt: item.aCnt
        }));

        saveSetsToStorage();
        populateSetSelect();
        document.getElementById('setSelect').value = name;
        statusEl.innerText = `"${name}" μ„ΈνΈλ΅ μ €μ¥λμ—μµλ‹λ‹¤.`;
    }

    function loadSelectedSet() {
        const sel = document.getElementById('setSelect');
        const name = sel.value;
        if (!name || !sets[name]) {
            alert('λ¶λ¬μ¬ μ„ΈνΈλ¥Ό μ„ νƒν•μ„Έμ”.');
            return;
        }
        if (!confirm(`"${name}" μ„ΈνΈλ¥Ό λ¶λ¬μ™€ ν„μ¬ λ©λ΅μ„ λ°”κΏ€κΉμ”?`)) return;

        playQueue = sets[name].map(item => ({
            q: item.q || '',
            qCnt: item.qCnt || 1,
            a: item.a || '',
            aCnt: item.aCnt || 1
        }));
        expandedDetails.clear();
        currentIndex = null;
        saveQueue();
        renderList();
        statusEl.innerText = `"${name}" μ„ΈνΈλ¥Ό λ¶λ¬μ™”μµλ‹λ‹¤.`;
    }

    function deleteSelectedSet() {
        const sel = document.getElementById('setSelect');
        const name = sel.value;
        if (!name || !sets[name]) {
            alert('μ‚­μ ν•  μ„ΈνΈλ¥Ό μ„ νƒν•μ„Έμ”.');
            return;
        }
        if (!confirm(`"${name}" μ„ΈνΈλ¥Ό μ‚­μ ν• κΉμ”?`)) return;

        delete sets[name];
        saveSetsToStorage();
        populateSetSelect();
        sel.value = '';
        statusEl.innerText = `"${name}" μ„ΈνΈκ°€ μ‚­μ λμ—μµλ‹λ‹¤.`;
    }

    // ---------- μμ„± μ„¤μ • ----------
    rateRange.addEventListener('input', () => {
        rateValue.innerText = 'ν„μ¬: ' + rateRange.value;
    });

    function loadVoicesList() {
        const available = speechSynthesis.getVoices();
        if (!available || available.length === 0) return;

        voices = available;

        const currentValue = voiceSelect.value;
        voiceSelect.innerHTML = '<option value="">κΈ°λ³Έ μ‹μ¤ν… μμ„± μ‚¬μ©</option>';

        const preferred = voices.filter(v => v.lang.startsWith('en') || v.lang.startsWith('ko'));
        const others = voices.filter(v => !v.lang.startsWith('en') && !v.lang.startsWith('ko'));

        [...preferred, ...others].forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.name;
            opt.textContent = v.name + ' (' + v.lang + ')';
            voiceSelect.appendChild(opt);
        });

        if (currentValue) {
            const found = Array.from(voiceSelect.options).find(o => o.value === currentValue);
            if (found) voiceSelect.value = currentValue;
        }
    }

    if (typeof speechSynthesis !== 'undefined') {
        setTimeout(loadVoicesList, 200);
        speechSynthesis.onvoiceschanged = loadVoicesList;
    }

    // ---------- μ¤ν¬λ¦½νΈ μ¶”κ°€/μμ • ----------
    function addOrUpdateScript() {
        const qText = document.getElementById('questionText').value.trim();
        const qCount = parseInt(document.getElementById('qRepeat').value) || 1;
        const aText = document.getElementById('answerText').value.trim();
        const aCount = parseInt(document.getElementById('aRepeat').value) || 1;

        if (!qText && !aText) {
            alert('μ§λ¬Έμ΄λ‚ λ‹µλ³€ μ¤‘ ν•λ‚λ” μ…λ ¥ν•΄μ•Ό ν•©λ‹λ‹¤.');
            return;
        }

        const newItem = { q: qText, qCnt: qCount, a: aText, aCnt: aCount };

        if (editingIndex !== null) {
            playQueue[editingIndex] = newItem;
            editingIndex = null;
            addBtn.textContent = 'λ©λ΅μ— μ¶”κ°€';
            statusEl.innerText = 'μμ •μ΄ μ™„λ£λμ—μµλ‹λ‹¤.';
        } else {
            playQueue.push(newItem);
            statusEl.innerText = 'λ©λ΅μ— μ¶”κ°€λμ—μµλ‹λ‹¤.';
        }

        saveQueue();
        renderList();
        clearInputOnly();
    }

    function clearInputOnly() {
        document.getElementById('questionText').value = '';
        document.getElementById('answerText').value = '';
        document.getElementById('qRepeat').value = 2;
        document.getElementById('aRepeat').value = 5;
        document.getElementById('questionText').focus();
    }

    function startEdit(index) {
        const item = playQueue[index];
        document.getElementById('questionText').value = item.q;
        document.getElementById('answerText').value = item.a;
        document.getElementById('qRepeat').value = item.qCnt;
        document.getElementById('aRepeat').value = item.aCnt;

        editingIndex = index;
        addBtn.textContent = 'μμ • μ™„λ£';
        statusEl.innerText = `#${index + 1} μ¤ν¬λ¦½νΈλ¥Ό μμ • μ¤‘μ…λ‹λ‹¤. μμ • ν›„ "μμ • μ™„λ£"λ¥Ό λλ¬μ£Όμ„Έμ”.`;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function deleteItem(index) {
        if (!confirm(`#${index + 1} μ¤ν¬λ¦½νΈλ¥Ό μ‚­μ ν• κΉμ”?`)) return;
        playQueue.splice(index, 1);
        saveQueue();
        renderList();
        statusEl.innerText = 'μ‚­μ λμ—μµλ‹λ‹¤.';

        if (editingIndex === index) {
            editingIndex = null;
            addBtn.textContent = 'λ©λ΅μ— μ¶”κ°€';
            clearInputOnly();
        }
        if (currentIndex === index) {
            currentIndex = null;
        }
    }

    function clearList() {
        if (!confirm('λ¨λ“  μ¤ν¬λ¦½νΈλ¥Ό μ΄κΈ°ν™”ν• κΉμ”?')) return;
        playQueue = [];
        expandedDetails.clear();
        currentIndex = null;
        saveQueue();
        renderList();
        stopAll();
        editingIndex = null;
        addBtn.textContent = 'λ©λ΅μ— μ¶”κ°€';
        statusEl.innerText = 'λ©λ΅μ΄ λ¨λ‘ μ‚­μ λμ—μµλ‹λ‹¤.';
    }

    function setCurrentIndex(idx) {
        currentIndex = idx;
        renderList();
    }

    function toggleDetail(event, index) {
        event.stopPropagation(); // μΉ΄λ“ ν΄λ¦­ μ¬μƒ λ§‰κΈ°
        if (expandedDetails.has(index)) {
            expandedDetails.delete(index);
        } else {
            expandedDetails.add(index);
        }
        renderList();
    }

    // ---------- λ©λ΅ λ λ”λ§ ----------
    function renderList() {
        const listDiv = document.getElementById('playList');
        listDiv.innerHTML = '';
        playQueue.forEach((item, index) => {
            const isActive = currentIndex === index;
            const isExpanded = expandedDetails.has(index);
            const detailClass = isExpanded ? 'script-detail' : 'script-detail collapsed';
            const toggleLabel = isExpanded ? 'μ ‘κΈ°' : 'νΌμΉκΈ°';

            const qText = item.q || '(μ§λ¬Έ μ—†μ)';
            const aText = item.a || '(λ‹µλ³€ μ—†μ)';

            listDiv.innerHTML += `
                <div class="script-item ${isActive ? 'active-item' : ''}" onclick="playSingle(${index})">
                    <div class="script-header">
                        <strong>#${index + 1}</strong>
                        <div class="script-buttons">
                            <button class="script-btn script-btn-toggle" onclick="toggleDetail(event, ${index})">${toggleLabel}</button>
                            <button class="script-btn script-btn-edit" onclick="event.stopPropagation(); startEdit(${index});">μμ •</button>
                            <button class="script-btn script-btn-delete" onclick="event.stopPropagation(); deleteItem(${index});">μ‚­μ </button>
                        </div>
                    </div>
                    <div>
                        <small>Q λ°λ³µ ${item.qCnt}ν / A λ°λ³µ ${item.aCnt}ν</small>
                    </div>
                    <div class="${detailClass}">
                        <div><strong>Q:</strong> ${qText.replace(/\n/g, '<br>')}</div>
                        <div style="margin-top:4px;"><strong>A:</strong> ${aText.replace(/\n/g, '<br>')}</div>
                    </div>
                </div>
            `;
        });
    }

    // ---------- λ§ν•κΈ° / μ¬μƒ ----------
    function speak(text, lang = 'en-US') {
        return new Promise((resolve, reject) => {
            if (!text) { resolve(); return; }

            if (voices.length === 0) {
                loadVoicesList();
            }

            const utterance = new SpeechSynthesisUtterance(text);

            const selectedName = voiceSelect.value;
            let selectedVoice = null;

            if (selectedName && voices.length > 0) {
                selectedVoice = voices.find(v => v.name === selectedName);
            }

            if (selectedVoice) {
                utterance.voice = selectedVoice;
                utterance.lang = selectedVoice.lang;
            } else {
                utterance.lang = lang;
            }

            utterance.rate = parseFloat(rateRange.value) || 0.9;

            utterance.onend = () => resolve();
            utterance.onerror = (e) => reject(e);

            currentUtterance = utterance;
            synth.speak(utterance);
        });
    }

    function wait(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // μ „μ²΄ λ¬΄ν• μ¬μƒ
    async function playAll() {
        if (playQueue.length === 0) {
            alert('μ¬μƒν•  λ©λ΅μ΄ μ—†μµλ‹λ‹¤.');
            return;
        }
        if (isPlaying) return;

        isPlaying = true;
        statusEl.innerText = 'μ¬μƒ μ¤‘...';

        const gapMs = (parseFloat(document.getElementById('gapSec').value) || 1) * 1000;

        while (isPlaying) {
            for (let i = 0; i < playQueue.length; i++) {
                if (!isPlaying) break;
                
                const item = playQueue[i];
                setCurrentIndex(i);

                for (let k = 0; k < item.qCnt; k++) {
                    if (!isPlaying) break;
                    if (item.q) {
                        statusEl.innerText = `#${i + 1} Q μ¬μƒ μ¤‘... (${k + 1}/${item.qCnt})`;
                        await speak(item.q);
                        await wait(gapMs);
                    }
                }

                for (let j = 0; j < item.aCnt; j++) {
                    if (!isPlaying) break;
                    if (item.a) {
                        statusEl.innerText = `#${i + 1} A μ¬μƒ μ¤‘... (${j + 1}/${item.aCnt})`;
                        await speak(item.a);
                        await wait(gapMs);
                    }
                }

                await wait(2000);
            }
        }
        setCurrentIndex(null);
    }

    // β… μΉ΄λ“ ν„°μΉ μ‹ ν•΄λ‹Ή ν•­λ©λ§ 1μ„ΈνΈ μ¬μƒ
    async function playSingle(index) {
        if (index < 0 || index >= playQueue.length) return;

        // λ‹¤λ¥Έ μ¬μƒ μ¤‘μ΄λ©΄ μ •μ§€
        if (isPlaying) {
            stopAll();
            await wait(200);
        }

        isPlaying = true;
        const item = playQueue[index];
        setCurrentIndex(index);

        const gapMs = (parseFloat(document.getElementById('gapSec').value) || 1) * 1000;

        // μ§λ¬Έ λ°λ³µ
        for (let k = 0; k < item.qCnt; k++) {
            if (!isPlaying) break;
            if (item.q) {
                statusEl.innerText = `#${index + 1} Q μ¬μƒ μ¤‘... (${k + 1}/${item.qCnt})`;
                await speak(item.q);
                await wait(gapMs);
            }
        }

        // λ‹µλ³€ λ°λ³µ
        for (let j = 0; j < item.aCnt; j++) {
            if (!isPlaying) break;
            if (item.a) {
                statusEl.innerText = `#${index + 1} A μ¬μƒ μ¤‘... (${j + 1}/${item.aCnt})`;
                await speak(item.a);
                await wait(gapMs);
            }
        }

        isPlaying = false;
        setCurrentIndex(null);
        statusEl.innerText = `#${index + 1} μ¬μƒμ΄ μ™„λ£λμ—μµλ‹λ‹¤.`;
    }

    function stopAll() {
        isPlaying = false;
        synth.cancel();
        setCurrentIndex(null);
        statusEl.innerText = 'μ •μ§€λ¨';
    }

    // νμ΄μ§€ λ΅λ“ μ‹ μ €μ¥λ λ©λ΅ & μ„ΈνΈ λ¶λ¬μ¤κΈ°
    window.addEventListener('load', () => {
        loadQueue();
        loadSetsFromStorage();
    });
</script>

</body>
</html>