<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¤í”½ ìŠ¤í¬ë¦½íŠ¸ ë°˜ë³µ ì¬ìƒê¸°</title>

    <!-- ì•„ì´í° í™ˆ í™”ë©´ ì¶”ê°€ìš© -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px 15px 80px;
            background-color: #f4f4f9;
        }
        h2 { color: #333; text-align: center; }
        .container {
            background: white;
            padding: 20px 15px 80px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        textarea {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
            font-size: 16px;
            box-sizing: border-box;
        }
        input[type="number"] {
            width: 70px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 15px;
            transition: 0.2s;
        }
        .btn-add { background-color: #4CAF50; color: white; }
        .btn-play { background-color: #2196F3; color: white; }
        .btn-stop { background-color: #f44336; color: white; }
        .btn-clear { background-color: #9e9e9e; color: white; }
        .list-area { margin-top: 20px; }
        .script-item {
            background: #e3f2fd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 5px solid #2196F3;
            font-size: 14px;
        }
        .status {
            text-align: center;
            margin-top: 10px;
            color: #ff5722;
            font-weight: bold;
            min-height: 20px;
            font-size: 14px;
        }
        .sticky-controls {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 8px 12px 12px;
            background: rgba(255,255,255,0.96);
            border-top: 1px solid #eee;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.06);
        }
        .small-label {
            font-size: 13px;
            font-weight: normal;
            color: #777;
        }
        select, input[type="range"] {
            width: 100%;
            margin-top: 3px;
            margin-bottom: 8px;
            padding: 5px;
            font-size: 13px;
            border-radius: 5px;
            border: 1px solid #ddd;
            box-sizing: border-box;
        }
        .row-2 {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .row-2 > div {
            flex: 1;
            min-width: 130px;
        }
        .hint-text {
            font-size: 12px;
            color: #777;
            margin-top: 4px;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ—£ï¸ ì˜¤í”½ ì‰ë„ì‰ í”Œë ˆì´ì–´</h2>

    <!-- ìŒì„± ì„¤ì • ì˜ì—­ -->
    <div class="input-group">
        <label>ìŒì„± ì„¤ì •</label>
        <div>
            <span class="small-label">Voice (ëª©ì†Œë¦¬ ì„ íƒ)</span>
            <select id="voiceSelect">
                <option value="">ê¸°ë³¸ ì‹œìŠ¤í…œ ìŒì„± ì‚¬ìš©</option>
            </select>
        </div>
        <div class="row-2">
            <div>
                <span class="small-label">ì†ë„ (0.6 ~ 1.4)</span>
                <input type="range" id="rateRange" min="0.6" max="1.4" step="0.05" value="0.9">
                <span id="rateValue" class="hint-text">í˜„ì¬: 0.9</span>
            </div>
            <div>
                <span class="small-label">ì§ˆë¬¸/ë‹µë³€ ì‚¬ì´ ê°„ê²© (ì´ˆ)</span>
                <input type="number" id="gapSec" min="0" max="5" value="1">
            </div>
        </div>
        <p class="hint-text">â€» iOSì—ì„œëŠ” ì‚¬íŒŒë¦¬ì—ì„œ í•œ ë²ˆ ì¬ìƒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ìŒì„± í•©ì„±ì´ ë™ì‘í•©ë‹ˆë‹¤.</p>
    </div>
    
    <div class="input-group">
        <label>Q. ì§ˆë¬¸ ì…ë ¥ (ì˜ì–´)</label>
        <textarea id="questionText" placeholder="ì˜ˆ: Tell me about yourself."></textarea>
        <label>ì§ˆë¬¸ ë°˜ë³µ íšŸìˆ˜: 
            <input type="number" id="qRepeat" value="2" min="1">
        </label>
    </div>

    <div class="input-group">
        <label>A. ë‹µë³€ ìŠ¤í¬ë¦½íŠ¸ ì…ë ¥ (ì˜ì–´)</label>
        <textarea id="answerText" placeholder="ì˜ˆ: I live in Seoul..."></textarea>
        <label>ë‹µë³€ ë°˜ë³µ íšŸìˆ˜: 
            <input type="number" id="aRepeat" value="5" min="1">
        </label>
    </div>

    <div class="controls">
        <button class="btn-add" onclick="addScript()">ëª©ë¡ì— ì¶”ê°€</button>
        <button class="btn-clear" onclick="clearList()">ì´ˆê¸°í™”</button>
    </div>

    <div class="list-area" id="playList"></div>

    <div class="status" id="statusMsg"></div>
</div>

<!-- í•˜ë‹¨ ê³ ì • ì¬ìƒ ë²„íŠ¼ -->
<div class="sticky-controls">
    <div class="controls" style="margin-top: 0;">
        <button class="btn-play" onclick="playAll()">â–¶ ì „ì²´ ì¬ìƒ (ë¬´í•œ ë°˜ë³µ)</button>
        <button class="btn-stop" onclick="stopAll()">â¹ ì •ì§€</button>
    </div>
</div>

<script>
    let playQueue = [];
    let isPlaying = false;
    let synth = window.speechSynthesis;
    let currentUtterance = null;
    let voices = [];

    const statusEl = document.getElementById('statusMsg');
    const voiceSelect = document.getElementById('voiceSelect');
    const rateRange = document.getElementById('rateRange');
    const rateValue = document.getElementById('rateValue');

    // ì†ë„ í‘œì‹œ ì—…ë°ì´íŠ¸
    rateRange.addEventListener('input', () => {
        rateValue.innerText = 'í˜„ì¬: ' + rateRange.value;
    });

    // ìŒì„± ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ì•„ì´í°/ì‚¬íŒŒë¦¬ ëŒ€ì‘)
    function loadVoices() {
        voices = synth.getVoices();
        voiceSelect.innerHTML = '<option value="">ê¸°ë³¸ ì‹œìŠ¤í…œ ìŒì„± ì‚¬ìš©</option>';

        // ì˜ì–´ ë° í•œêµ­ì–´ ìŒì„±ë§Œ ìš°ì„  ë…¸ì¶œ
        const filtered = voices.filter(v => v.lang.startsWith('en') || v.lang.startsWith('ko'));

        filtered.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.name;
            opt.textContent = v.name + ' (' + v.lang + ')';
            voiceSelect.appendChild(opt);
        });
    }

    // iOSì—ì„œëŠ” onvoiceschangedê°€ ì—¬ëŸ¬ ë²ˆ í˜¸ì¶œë˜ê¸°ë„ í•´ì„œ ë°©ì–´ì ìœ¼ë¡œ ì²˜ë¦¬
    if (typeof speechSynthesis !== 'undefined') {
        loadVoices();
        speechSynthesis.onvoiceschanged = loadVoices;
    }

    // ëª©ë¡ì— ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
    function addScript() {
        const qText = document.getElementById('questionText').value.trim();
        const qCount = parseInt(document.getElementById('qRepeat').value) || 1;
        const aText = document.getElementById('answerText').value.trim();
        const aCount = parseInt(document.getElementById('aRepeat').value) || 1;

        if (!qText && !aText) {
            alert('ì§ˆë¬¸ì´ë‚˜ ë‹µë³€ ì¤‘ í•˜ë‚˜ëŠ” ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
            return;
        }

        playQueue.push({ q: qText, qCnt: qCount, a: aText, aCnt: aCount });
        renderList();

        // ì…ë ¥ì°½ ë¹„ìš°ê¸°
        document.getElementById('questionText').value = '';
        document.getElementById('answerText').value = '';
        document.getElementById('questionText').focus();
    }

    // í™”ë©´ì— ëª©ë¡ í‘œì‹œ
    function renderList() {
        const listDiv = document.getElementById('playList');
        listDiv.innerHTML = '';
        playQueue.forEach((item, index) => {
            const qPreview = item.q ? item.q.substring(0, 40) : '(ì—†ìŒ)';
            const aPreview = item.a ? item.a.substring(0, 40) : '(ì—†ìŒ)';
            listDiv.innerHTML += `
                <div class="script-item">
                    <strong>#${index + 1}</strong><br>
                    <small>Q (${item.qCnt}íšŒ):</small> ${qPreview}${item.q.length > 40 ? '...' : ''}<br>
                    <small>A (${item.aCnt}íšŒ):</small> ${aPreview}${item.a.length > 40 ? '...' : ''}
                </div>
            `;
        });
    }

    function clearList() {
        playQueue = [];
        renderList();
        stopAll();
    }

    // ë§í•˜ê¸° í•¨ìˆ˜ (Promise ì‚¬ìš©)
    function speak(text, lang = 'en-US') {
        return new Promise((resolve, reject) => {
            if (!text) { resolve(); return; }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;

            // ì„ íƒëœ ëª©ì†Œë¦¬ ì ìš©
            const selectedName = voiceSelect.value;
            if (selectedName && voices.length > 0) {
                const selectedVoice = voices.find(v => v.name === selectedName);
                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                    utterance.lang = selectedVoice.lang;
                }
            }

            // ì†ë„ ì ìš©
            utterance.rate = parseFloat(rateRange.value) || 0.9;

            utterance.onend = () => resolve();
            utterance.onerror = (e) => reject(e);

            currentUtterance = utterance;
            synth.speak(utterance);
        });
    }

    // ì ì‹œ ë©ˆì¶¤ (ê°„ê²©)
    function wait(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // ì „ì²´ ì¬ìƒ ë¡œì§ (ë¬´í•œ ë°˜ë³µ)
    async function playAll() {
        if (playQueue.length === 0) {
            alert('ì¬ìƒí•  ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        if (isPlaying) return;

        isPlaying = true;
        statusEl.innerText = 'ì¬ìƒ ì¤‘...';

        const gapMs = (parseFloat(document.getElementById('gapSec').value) || 1) * 1000;

        // ë¬´í•œ ë£¨í”„ (ì˜ ë•Œ ë“£ê¸° ìœ„í•´)
        while (isPlaying) {
            for (let i = 0; i < playQueue.length; i++) {
                if (!isPlaying) break;
                
                const item = playQueue[i];

                // ì§ˆë¬¸ ë°˜ë³µ ì¬ìƒ
                for (let k = 0; k < item.qCnt; k++) {
                    if (!isPlaying) break;
                    if (item.q) {
                        statusEl.innerText = `Q ì¬ìƒ ì¤‘... (${k + 1}/${item.qCnt})`;
                        await speak(item.q);
                        await wait(gapMs);
                    }
                }

                // ë‹µë³€ ë°˜ë³µ ì¬ìƒ
                for (let j = 0; j < item.aCnt; j++) {
                    if (!isPlaying) break;
                    if (item.a) {
                        statusEl.innerText = `A ì¬ìƒ ì¤‘... (${j + 1}/${item.aCnt})`;
                        await speak(item.a);
                        await wait(gapMs);
                    }
                }

                // ë‹¤ìŒ ì„¸íŠ¸ë¡œ ë„˜ì–´ê°€ê¸° ì „ ì ê¹ ëŒ€ê¸°
                await wait(2000);
            }
        }
    }

    function stopAll() {
        isPlaying = false;
        synth.cancel();
        statusEl.innerText = 'ì •ì§€ë¨';
    }
</script>

</body>
</html>